<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è¯†åº“ç®¡ç† - RAG çŸ¥è¯†åº“ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        .kb-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .kb-card {
            position: relative;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .kb-card:hover {
            transform: translateY(-4px);
        }

        .kb-card::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: var(--radius);
            background: linear-gradient(135deg, hsl(var(--gradient-from) / 0.1) 0%, hsl(var(--gradient-to) / 0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .kb-card:hover::before {
            opacity: 1;
        }

        .kb-content {
            position: relative;
            z-index: 1;
        }

        .kb-icon-wrapper {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: linear-gradient(135deg, hsl(var(--gradient-from) / 0.15) 0%, hsl(var(--gradient-to) / 0.15) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            font-size: 1.75rem;
            transition: all 0.3s ease;
        }

        .kb-card:hover .kb-icon-wrapper {
            background: linear-gradient(135deg, hsl(var(--gradient-from)) 0%, hsl(var(--gradient-to)) 100%);
            transform: scale(1.1);
        }

        .kb-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: hsl(var(--foreground));
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .kb-description {
            font-size: 0.875rem;
            color: hsl(var(--muted-foreground));
            margin-bottom: 1rem;
            min-height: 2.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.25;
        }

        .kb-meta {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.8125rem;
            color: hsl(var(--muted-foreground));
            padding-bottom: 0.75rem;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid hsl(var(--border) / 0.5);
        }

        .kb-meta-item {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .kb-actions {
            display: flex;
            gap: 0.5rem;
        }

        .kb-action-btn {
            flex: 1;
            padding: 0.5rem;
            font-size: 0.8125rem;
            border-radius: calc(var(--radius) - 2px);
            border: 1px solid hsl(var(--border));
            background: hsl(var(--background));
            color: hsl(var(--foreground));
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .kb-action-btn:hover {
            background: hsl(var(--accent));
        }

        .kb-action-btn.delete {
            color: hsl(var(--destructive));
            border-color: hsl(var(--destructive) / 0.2);
        }

        .kb-action-btn.delete:hover {
            background: hsl(var(--destructive) / 0.1);
        }

        /* æ¨¡æ€æ¡†è¡¨å• */
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: hsl(var(--foreground));
        }

        .form-hint {
            font-size: 0.75rem;
            color: hsl(var(--muted-foreground));
            margin-top: 0.25rem;
        }

        .modal-header {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1.25rem;
            color: hsl(var(--foreground));
        }

        .modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .header-title {
            font-size: 1.125rem;
            font-weight: 600;
            background: linear-gradient(135deg, hsl(var(--gradient-from)) 0%, hsl(var(--gradient-to)) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-link {
            padding: 0.5rem 1rem;
            border-radius: calc(var(--radius) - 2px);
            font-size: 0.875rem;
            font-weight: 500;
            color: hsl(var(--muted-foreground));
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            color: hsl(var(--foreground));
            background: hsl(var(--accent));
        }

        .nav-link.active {
            color: hsl(var(--primary-foreground));
            background: linear-gradient(135deg, hsl(var(--gradient-from)) 0%, hsl(var(--gradient-to)) 100%);
        }

        .nav-link.logout {
            color: hsl(var(--destructive));
        }

        .nav-link.logout:hover {
            background: hsl(var(--destructive) / 0.1);
        }

        /* é¡µé¢å¤´éƒ¨ */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-header-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: hsl(var(--foreground));
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="header">
        <h1 class="header-title">RAG çŸ¥è¯†åº“ç³»ç»Ÿ</h1>
        <div class="flex items-center gap-4">
            <button class="theme-toggle" id="themeToggle" title="åˆ‡æ¢ä¸»é¢˜">
                <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
            </button>
            <a href="/static/index.html" class="nav-link">æ™ºèƒ½é—®ç­”</a>
            <a href="/static/upload.html" class="nav-link active">çŸ¥è¯†åº“ç®¡ç†</a>
            <button class="nav-link logout" id="logoutBtn">é€€å‡º</button>
        </div>
    </header>

    <!-- ä¸»å†…å®¹ -->
    <main class="main-content">
        <div class="page-header">
            <h2 class="page-header-title">æˆ‘çš„çŸ¥è¯†åº“</h2>
            <button class="btn btn-primary" id="createKbBtn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                åˆ›å»ºçŸ¥è¯†åº“
            </button>
        </div>
        <div class="kb-grid" id="kbGrid">
            <!-- çŸ¥è¯†åº“å¡ç‰‡å°†åŠ¨æ€åŠ è½½ -->
        </div>
    </main>

    <!-- åˆ›å»ºçŸ¥è¯†åº“å¼¹çª— -->
    <div class="modal-overlay hidden" id="createKbModal">
        <div class="modal-content">
            <div class="modal-header">åˆ›å»ºçŸ¥è¯†åº“</div>
            <div class="mb-4">
                <label class="form-label" for="kbName">çŸ¥è¯†åº“åç§° *</label>
                <input type="text" id="kbName" class="input" placeholder="è¯·è¾“å…¥çŸ¥è¯†åº“åç§°">
                <p class="form-hint">æœ€å¤š 100 ä¸ªå­—ç¬¦</p>
            </div>
            <div class="mb-4">
                <label class="form-label" for="kbDesc">æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                <textarea id="kbDesc" class="textarea" placeholder="è¯·è¾“å…¥çŸ¥è¯†åº“æè¿°"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelCreateKb">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="confirmCreateKb">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <!-- Toast æç¤º -->
    <div class="toast hidden" id="toast">
        <span id="toastMessage"></span>
    </div>

    <script src="/static/js/common.js"></script>
    <script>
        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            await initTheme();
            await loadKnowledgeBases();
            setupEventListeners();
        });

        // åŠ è½½çŸ¥è¯†åº“åˆ—è¡¨
        async function loadKnowledgeBases() {
            try {
                const response = await fetch('/api/knowledge-bases', {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                const kbs = await response.json();

                const kbGrid = document.getElementById('kbGrid');
                kbGrid.innerHTML = kbs.map(kb => `
                    <div class="kb-card card" onclick="enterKnowledgeBase(${kb.id})">
                        <div class="kb-content">
                            <div class="kb-icon-wrapper">ğŸ“š</div>
                            <h3 class="kb-title" title="${escapeHtml(kb.name)}">${escapeHtml(kb.name)}</h3>
                            <p class="kb-description">${kb.description ? escapeHtml(kb.description) : 'æš‚æ— æè¿°'}</p>
                            <div class="kb-meta">
                                <span class="kb-meta-item">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                        <line x1="16" y1="13" x2="8" y2="13"></line>
                                        <line x1="16" y1="17" x2="8" y2="17"></line>
                                        <polyline points="10 9 9 9 8 9"></polyline>
                                    </svg>
                                    ${kb.document_count} ä¸ªæ–‡æ¡£
                                </span>
                                <span class="kb-meta-item">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                    ${kb.formatted_created_at || formatDate(kb.created_at)}
                                </span>
                            </div>
                            <div class="kb-actions" onclick="event.stopPropagation()">
                                <button class="kb-action-btn" onclick="editKnowledgeBase(${kb.id}, '${escapeHtml(kb.name).replace(/'/g, "\\'")}', '${escapeHtml(kb.description || '').replace(/'/g, "\\'")}')">ç¼–è¾‘</button>
                                <button class="kb-action-btn delete" onclick="deleteKnowledgeBase(${kb.id})">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>
                `).join('');

                if (kbs.length === 0) {
                    kbGrid.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1;">
                            <div class="empty-state-icon">ğŸ“š</div>
                            <div class="empty-state-text">æš‚æ— çŸ¥è¯†åº“</div>
                            <div class="empty-state-sub">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªçŸ¥è¯†åº“</div>
                        </div>
                    `;
                }
            } catch (error) {
                showToast('åŠ è½½çŸ¥è¯†åº“åˆ—è¡¨å¤±è´¥', 'error');
            }
        }

        // è¿›å…¥çŸ¥è¯†åº“
        function enterKnowledgeBase(kbId) {
            window.location.href = `/static/kb_detail.html?kb_id=${kbId}`;
        }

        // åˆ›å»ºçŸ¥è¯†åº“
        async function createKnowledgeBase() {
            const name = document.getElementById('kbName').value.trim();
            const description = document.getElementById('kbDesc').value.trim();

            if (!name) {
                showToast('è¯·è¾“å…¥çŸ¥è¯†åº“åç§°', 'error');
                return;
            }

            try {
                const response = await fetch('/api/knowledge-bases', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, description })
                });

                if (response.ok) {
                    showToast('çŸ¥è¯†åº“åˆ›å»ºæˆåŠŸ', 'success');
                    hideCreateKbModal();
                    document.getElementById('kbName').value = '';
                    document.getElementById('kbDesc').value = '';
                    await loadKnowledgeBases();
                } else {
                    const data = await response.json();
                    showToast(data.detail || 'åˆ›å»ºå¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // åˆ é™¤çŸ¥è¯†åº“
        async function deleteKnowledgeBase(kbId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçŸ¥è¯†åº“å—ï¼Ÿåˆ é™¤å‰è¯·ç¡®ä¿è¯¥çŸ¥è¯†åº“ä¸‹æ²¡æœ‰æ–‡æ¡£ã€‚')) return;

            try {
                const response = await fetch(`/api/knowledge-bases/${kbId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                if (response.ok) {
                    showToast('çŸ¥è¯†åº“åˆ é™¤æˆåŠŸ', 'success');
                    await loadKnowledgeBases();
                } else {
                    const data = await response.json();
                    showToast(data.detail || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // ç¼–è¾‘çŸ¥è¯†åº“
        async function editKnowledgeBase(kbId, currentName, currentDesc) {
            const newName = prompt('è¯·è¾“å…¥æ–°çš„çŸ¥è¯†åº“åç§°ï¼š', currentName);
            if (!newName) return;

            try {
                const response = await fetch(`/api/knowledge-bases/${kbId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: newName })
                });

                if (response.ok) {
                    showToast('çŸ¥è¯†åº“æ›´æ–°æˆåŠŸ', 'success');
                    await loadKnowledgeBases();
                } else {
                    const data = await response.json();
                    showToast(data.detail || 'æ›´æ–°å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('æ›´æ–°å¤±è´¥', 'error');
            }
        }

        // æ˜¾ç¤º/éšè—åˆ›å»ºçŸ¥è¯†åº“å¼¹çª—
        function showCreateKbModal() {
            document.getElementById('createKbModal').classList.remove('hidden');
            document.getElementById('kbName').focus();
        }

        function hideCreateKbModal() {
            document.getElementById('createKbModal').classList.add('hidden');
        }

        // äº‹ä»¶ç›‘å¬
        function setupEventListeners() {
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('createKbBtn').addEventListener('click', showCreateKbModal);
            document.getElementById('cancelCreateKb').addEventListener('click', hideCreateKbModal);
            document.getElementById('confirmCreateKb').addEventListener('click', createKnowledgeBase);
        }
    </script>
</body>
</html>
